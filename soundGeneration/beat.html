<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
<body>
  <script src="js/getSlices.js"></script>
<script>

loadSounds()
var audioData = []
var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function loadSounds() {

  soundsBase = "sounds/"
  soundEndings = ".mp3"
  names = ["BD0000", "BD0000", "CB", "CH", "CL", "CP", "CY0000", "SD0025", "SD0010", "SD0050", "RS"] // SD0010.mp3

  for (var i = 0; i < names.length; i++) {
    loadSound(i, soundsBase + names[i] + soundEndings)
  }

  // create web audio api context
  function loadSound(index, url) {
    // Note: this loads asynchronously
    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    // Our asynchronous callback
    request.onload = function() {
        audioData[index] = request.response;
    };
    request.send();
  }
}

// This is the code we are interested in
function playSounds(indicies) {
  for (var i = 0; i < indicies.length; i++) {
    playSound(audioData[indicies[i]])
  }
}

function playSound(audioData) {
  // create a sound source
  var soundSource = audioCtx.createBufferSource()
  soundSource.connect(audioCtx.destination)

  // The Audio Context handles creating source buffers from raw binary
  audioCtx.decodeAudioData(audioData, function(soundBuffer){
      soundSource.buffer = soundBuffer
      soundSource.start()
  })
}

function slice2sound(slice, threshold) {
  var sound = []
  var N = audioData.length
  for (var i = 0; i < Math.min(slice.length,N); i++) {
    if (slice[i] > threshold) {
      sound.push(i)
    }
  }

  if (sound.length === 0) {
    return slice2sound(slice, threshold * 0.8)
  }

  return sound
}

var i = 0
function playLoop() {
  window.setInterval(function(){
    if (i%4 === 0) {
      playSounds(slice2sound(getSlice().reverse(), 0.5))
    }
    playSounds(slice2sound(getSlice(), 0.5))
    i++
  }, 300);
}

function createAlert(text) {
  playLoop()
}

getSlices('https://farm8.staticflickr.com/7638/16295032003_ef5fa05542.jpg', 200, 10)
.then(function(r) {
  slices = r // put slices in global slices array
})


</script>

<button onclick="createAlert('hadsalksjnd')">Click me</button>

</body>
</html>
