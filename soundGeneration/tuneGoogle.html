<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
<body>
  <script src="js/dsp.js"></script>
  <script src="js/freqSound.js"></script>
<script>


playTextWithPitchSpeed("og se hende br√¶nde", 1.0, 1.0)

function playTextWithPitchSpeed(text, shift, rate) {
  var url = 'http://thingsinjars.com/lab/web-audio-tutorial/hello.mp3'
  // var url = 'http://translate.google.com/translate_tts?tl=da&q=' + encodeURIComponent(text)
  console.log(url)

  var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  var fftFrameSize = 2048;
  var nSamples = 2048;
  var fft = new FFT(fftFrameSize, audioCtx.sampleRate);
  // var shifter = new Pitchshift(fftFrameSize, audioCtx.sampleRate, 'FFT');
  var shifter = new FreqSound(fftFrameSize, audioCtx.sampleRate, 'FFT');

  var scriptNode = audioCtx.createScriptProcessor(nSamples, 1, 1);


  // Give the node a function to process audio events
  scriptNode.onaudioprocess = function(audioProcessingEvent) {
    var inputBuffer = audioProcessingEvent.inputBuffer;
    var outputBuffer = audioProcessingEvent.outputBuffer;

    // Loop through the output channels (in this case there is only one)
    for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
      var inputData = inputBuffer.getChannelData(channel);
      var outputData = outputBuffer.getChannelData(channel);

      // fft.forward(inputData)
      data = getFrequencies([200,400,Math.random()*1000], fftFrameSize, audioCtx.sampleRate)
      for (var i = 0; i < fft.real.length; i++) {
        fft.real[i] = data[i]
      }

      shifter.process(shift, inputData.length, 4, inputData, fft);
      var out_data = outputData;
      for (i = 0; i < out_data.length; ++i) {
          out_data[i] = shifter.outdata[i];
      }
    }
  }

  // create web audio api context

  function startSound() {
          // Note: this loads asynchronously
          var request = new XMLHttpRequest();
          request.open("GET", url, true);
          request.responseType = "arraybuffer";

          // Our asynchronous callback
          request.onload = function() {
              var audioData = request.response;
              audioGraph(audioData);
          };
          request.send();
      }

    // var coolEffect = (function() {
    //     var convolver = audioCtx.createConvolver(),
    //         noiseBuffer = audioCtx.createBuffer(2, 0.2 * audioCtx.sampleRate, audioCtx.sampleRate),
    //         left = noiseBuffer.getChannelData(0),
    //         right = noiseBuffer.getChannelData(1);
    //     for (var i = 0; i < noiseBuffer.length; i++) {
    //         left[i] = Math.random() * 2 - 1;
    //         right[i] = Math.random() * 2 - 1;
    //     }
    //     convolver.buffer = noiseBuffer;
    //     return convolver;
    //   })();

  // This is the code we are interested in
  function audioGraph(audioData) {
      // create a sound source
      soundSource = audioCtx.createBufferSource()
      soundSource.playbackRate.value = rate
      soundSource.connect(scriptNode)
      scriptNode.connect(audioCtx.destination)
      // scriptNode.connect(coolEffect)
      // CoVeffect.connect(audioCtx.destination)

      // The Audio Context handles creating source buffers from raw binary
      audioCtx.decodeAudioData(audioData, function(soundBuffer){
          soundSource.buffer = soundBuffer;
          soundSource.start(audioCtx.currentTime);
      });
  }
  startSound()
}

function fullFreqVector(inputFreq, fftFrameSize) {
  if (inputFreq.length*2 != fftFrameSize) {
    console.log("length Error")
  }
  var out = new Array(fftFrameSize)
  for (var i = 0; i <= fftFrameSize_2; i++) {
    out[i] = inputFreq[i];
  }
  for (var i = 1; i<fftFrameSize_2; i++) {
    out[fftFrameSize_2+i] = out[fftFrameSize_2-i]
  }
  return out
}

function getFrequencies(frequyencies, fftFrameSize, sampleRate) {
  freqPerBin = sampleRate / fftFrameSize
  fftFrameSize_2 = fftFrameSize/2
  var out = new Array(fftFrameSize)
  for (var i = 0; i <= fftFrameSize_2; i++) {
    out[i] = 0;
  }

  for (var i = 0; i < frequyencies.length; i++) {
    out[Math.floor(frequyencies[i]/freqPerBin)]=fftFrameSize/(frequyencies.length*2)
  }

  for (var i = 1; i<fftFrameSize_2; i++) {
    out[fftFrameSize_2+i] = out[fftFrameSize_2-i]
  }
  return out
}

</script>
</body>
